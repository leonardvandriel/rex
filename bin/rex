#!/bin/bash

verbose_ssh=''
verbose_rsync=''

if [ "$1" == "--install" ]; then
  if [ ! -f bin/rex ]; then echo "cannot install from here"; exit 1; fi
  cp bin/rex /usr/local/bin
  exit
fi

for i in `seq 1 2`;
do
  if [ "$1" == "--verbose" ] || [ "$1" == "-v" ]; then
    shift
    verbose_rsync="$verbose_rsync --progress"
  fi
  if [ "$1" == "--debug" ] || [ "$1" == "-d" ]; then
    shift
    verbose_rsync="$verbose_rsync -v --stats -i"
    verbose_ssh="$verbose_ssh -v"
  fi
done

if [ -z $1 ] || [ "$1" == "--help" ] || [ "$1" == "-h" ]; then
  echo "usage: rex [options] [command]"
  echo "   rex [options] command   sync and run command remotely"
  echo "   rex --init config, -i   init new config"
  echo "   rex --select config, -s activate config"
  echo "   rex --list, -l          list available configs"
  echo "   rex --current, -c       show current config"
  echo "   rex --help, -h          show help"
  echo "       --verbose, -v       show verbose output"
  echo "       --debug, -d         show debug output"
  exit
fi

if [ "$1" == "--init" ] || [ "$1" == "-i" ]; then
  if [ -z $2 ]; then echo "specify config to init, try '--init config"; exit 1; fi
  if [ -f .rex/$2 ]; then echo "config '$2' already exists, try '--select $2'"; exit 1; fi
  mkdir -p .rex
  echo "user=username\naddr=192.168.0.10\nport=22\npath=files/project\nsync=output\nignore=bin,build,tmp" > .rex/$2
  cat .rex/$2
  echo "$2" > .rex/.current
  "${EDITOR:-vi}" .rex/$2
  exit
fi

if [ "$1" == "--select" ] || [ "$1" == "-s" ]; then
  available=$(ls -1 .rex | tr '\n' '/')
  if [ -z $2 ]; then echo "specify config to select, try: '--select ${available%?}'"; exit 1; fi
  if [ ! -f .rex/$2 ]; then echo "config '$2' does not exist, try: '--select ${available%?}'"; exit 1; fi
  echo "$2" > .rex/.current
  exit
fi

if [ "$1" == "--list" ] || [ "$1" == "-l" ]; then
  ls -1 .rex
  exit
fi

if [ ! -f .rex/.current ]; then echo "no config selected, try '--init config'"; exit 1; fi

current=$(cat .rex/.current)

if [ ! -f .rex/$current ]; then echo "invalid config selected, try '--select config'"; exit 1; fi

if [ "$1" == "--current" ] || [ "$1" == "-c" ]; then
  cat .rex/$current
  exit
fi

if [ "${1:0:1}" == '-' ]; then echo "unknown option '$1', try '--help'"; exit 1; fi

. .rex/$current

if [ -z ${user+x} ]; then echo "'user=' not in config"; exit 1; fi
if [ -z ${addr+x} ]; then echo "'addr=' not in config"; exit 1; fi
if [ -z ${port+x} ]; then echo "'port=' not in config"; exit 1; fi
if [ -z ${path+x} ]; then echo "'path=' not in config"; exit 1; fi
if [ -z ${sync+x} ]; then echo "'sync=' not in config"; exit 1; fi
if [ -z ${ignore+x} ]; then echo "'ignore=' not in config"; exit 1; fi

if [ ! -z $verbose_rsync ]; then
  set -x
fi

exclude="${ignore//,/ --exclude=}"

rsync $verbose_rsync -aze "ssh -p $port" --exclude=$exclude --exclude=.* --delete . $user@$addr:$path

ssh $verbose_ssh -o LogLevel=QUIET -t -p $port $user@$addr "cd $path && mkdir -p $sync && $@"

rsync $verbose_rsync -aze "ssh -p $port" --exclude={$ignore} $user@$addr:$path/$sync/ $sync
